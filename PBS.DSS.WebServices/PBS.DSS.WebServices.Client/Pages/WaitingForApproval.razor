@page "/WaitingForApproval"
@page "/WaitingForApproval/{SerialNumber}/{WorkItemRef}"
@page "/WaitingForApproval/{SerialNumber}/{WorkItemRef}/{Requestor}"

<MudSessionErrorWrapper Validate="ValidateParams" FetchAsync="Initialize">
    <Content>
        <MudContainer>
            <MudStack AlignItems="AlignItems.Center" Class="mb-20">
                <MudGrid Justify="Justify.Center">
                    <MudItem lg="5" md="6" xs="12">
                        <MudPaper Elevation="4" Class="paper-card-fit">
                            <MudStack AlignItems="AlignItems.Stretch" Spacing="1">
                                <MudText Typo="Typo.h6" Align="Align.Center">@Resources.ServiceOrder</MudText>
                                <MudDivider />
                                <MudSpacer />
                                <MudStack Row="true">
                                    <MudText>@Resources.SO #:</MudText>
                                    <MudSpacer />
                                    <MudText>@ServiceOrder.SONumber</MudText>
                                </MudStack>
                                <MudStack Row="true">
                                    <MudText>@Resources.ServiceAdvisor:</MudText>
                                    <MudSpacer />
                                    <MudText>@ServiceOrder.AdvisorName</MudText>
                                </MudStack>
                                <MudStack Row="true" AlignItems="AlignItems.Center">
                                    <MudText>@Resources.Inspection:</MudText>
                                    <MudSpacer />
                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Primary"
                                               StartIcon="@Icons.Material.Outlined.Checklist"
                                               OnClick="ViewInspection">
                                        View
                                    </MudButton>
                                </MudStack>
                            </MudStack>
                        </MudPaper>
                    </MudItem>

                    <MudItem lg="5" md="6" xs="12">
                        <MudPaper Elevation="4" Class="paper-card-fit">
                            <MudStack AlignItems="AlignItems.Center" Spacing="1">
                                <MudText Typo="Typo.h6">@Resources.VehicleDetails</MudText>
                                <MudDivider />
                                <MudSpacer />
                                <MudText>@ServiceOrder.Vehicle.Description</MudText>
                                <MudText>@ServiceOrder.Vehicle.VIN</MudText>
                            </MudStack>
                        </MudPaper>
                    </MudItem>

                    @if (ServiceOrder.AdditionalComments.HasValue())
                    {
                        <MudItem lg="10" md="12" xs="12">
                            <MudPaper Elevation="4" Class="paper-card-wrap">
                                <MudStack Spacing="1" AlignItems="AlignItems.Center">
                                    <MudText Typo="Typo.h6">@Resources.AdditionalComments</MudText>
                                    <MudDivider />
                                    <MudSpacer />
                                    <MudText>@ServiceOrder.AdditionalComments</MudText>
                                </MudStack>
                            </MudPaper>
                        </MudItem>
                    }
                </MudGrid>

                <MudGrid Justify="Justify.Center" Class="mb-4">
                    <MudItem lg="10" md="12" xs="12">
                        <MudText Typo="Typo.h5" Align="Align.Center" Class="mt-4">@Resources.ServiceRecommendations</MudText>
                        <MudDivider />
                    </MudItem>
                </MudGrid>

                <MudGrid Justify="Justify.Center">
                    @foreach (var pending in ServiceOrder.PendingRequests)
                    {
                        <MudItem lg="@((pending == ServiceOrder.PendingRequests.Last()) ? 10: 5)"
                                 md="@((pending == ServiceOrder.PendingRequests.Last()) ? 8: 4)"
                                 xs="12">
                            <MudPaper Elevation="4"
                                      Class="paper-card-wrap"
                                      Style="@pending.Priority.PaperShadowStyle()">
                                <MudStack Spacing="1" AlignItems="AlignItems.Center">
                                    <MudText Style="@pending.Priority.LabelStyle()" Class="pl-2 pr-2 mb-2">
                                        @pending.Priority.FriendlyText()
                                    </MudText>

                                    <MudGrid Spacing="0">
                                        <MudItem xs="9">
                                            <MudText>@pending.Description</MudText>
                                        </MudItem>
                                        <MudItem xs="3">
                                            <MudText Align="Align.End">@((pending.EstimatedLabour + pending.EstimatedParts).ToString("C2"))</MudText>
                                        </MudItem>
                                    </MudGrid>

                                    <MudStack AlignItems="AlignItems.Start"
                                              Justify="Justify.Center"
                                              Row="true">
                                        <MudButton Color="Color.Success"
                                                   StartIcon="@Icons.Material.Filled.Check"
                                                   Size="Size.Small"
                                                   Variant="@(pending.MarkedForApproval.HasValue && pending.MarkedForApproval.Value ? Variant.Filled: Variant.Outlined)"
                                                   OnClick="() => SetApproval(pending, true)">
                                            @Resources.Approve
                                        </MudButton>
                                        <MudButton Color="Color.Error"
                                                   StartIcon="@Icons.Material.Filled.Close"
                                                   Size="Size.Small"
                                                   Variant="@(!pending.MarkedForApproval.HasValue || pending.MarkedForApproval.Value ? Variant.Outlined : Variant.Filled)"
                                                   OnClick="() => SetApproval(pending, false)">
                                            @Resources.Decline
                                        </MudButton>
                                    </MudStack>
                                </MudStack>
                            </MudPaper>
                        </MudItem>
                    }
                </MudGrid>

                <MudGrid Justify="Justify.Center" Class="mb-4">
                    <MudItem lg="10" md="12" xs="12">
                        <MudText Typo="Typo.h5" Align="Align.Center" Class="mt-4">@Resources.ApprovedServices</MudText>
                        <MudDivider />
                    </MudItem>
                </MudGrid>

                <MudGrid Justify="Justify.Center">
                    @foreach (var approved in ServiceOrder.ApprovedRequests)
                    {
                        <MudItem lg="@((approved == ServiceOrder.ApprovedRequests.Last()) ? 10: 5)"
                                 md="@((approved == ServiceOrder.ApprovedRequests.Last()) ? 8: 4)"
                                 xs="12">
                            <MudPaper Elevation="4" Class="paper-card-wrap">
                                <MudStack Spacing="1">
                                    <MudText>@approved.Description</MudText>
                                </MudStack>
                            </MudPaper>
                        </MudItem>
                    }
                </MudGrid>
            </MudStack>
        </MudContainer>

        <MudPaper Elevation="0" class="page-footer-pinned">
            <MudGrid Justify="Justify.FlexEnd" Style="align-items:center;" Spacing="2">
                <MudItem xs="12" lg="8">
                    <MudStack AlignItems="AlignItems.Center" Spacing="0">
                        <MudStack Row="true" Spacing="3">
                            <MudText Typo="Typo.h6">@Resources.Subtotal: @SubTotal.ToString("C2")</MudText>
                            <MudText Typo="Typo.h6">@Resources.Taxes: @Taxes.ToString("C2")</MudText>
                            <MudText Typo="Typo.h6">@Resources.Fees: @Fees.ToString("C2")</MudText>
                        </MudStack>
                        <MudText Typo="Typo.h6">@Resources.Total: @GrandTotal.ToString("C2")</MudText>
                    </MudStack>
                </MudItem>
                <MudItem xs="8" md="2" lg="2">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               Style="padding-left:8%; padding-right:8%;"
                               StartIcon="@Icons.Material.Outlined.CheckCircle"
                               OnClick="Confirm">
                        @Resources.Confirm
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>
    </Content>
</MudSessionErrorWrapper>

@code {
    [Parameter]
    public string SerialNumber { get; set; } = string.Empty;
    [Parameter]
    public string WorkItemRef { get; set; } = string.Empty;
    [Parameter]
    public string Requestor { get; set; } = string.Empty;

    private ServiceOrder ServiceOrder { get; set; } = new();

    private double SubTotal { get; set; } = 0;
    private double Taxes { get; set; } = 0;
    private double Fees { get; set; } = 0;
    private double GrandTotal => SubTotal + Taxes + Fees;


    private async Task Initialize()
    {
        //Debug Code
        ServiceOrder = ServiceOrder.GenerateDummy();
        SerialNumber = "1156.QA";
        CalculateTotals();
        return;

        SharedStateService.SharedState.SerialNumber = SerialNumber;

        var busyDialog = DialogService.Show<MudBusyDialog>("");
        var args = new ServiceOrderFetchArgs() { SerialNumber = SerialNumber, ServiceOrderRef = ServiceOrder.Id };

        var resp = await ControllerAPIService.FetchServiceOrder(args);

        busyDialog.Close();

        if (resp.HasError)
        {
            SharedStateService.SetInvalidServiceOrderError();
            return;
        }

        ServiceOrder = resp.ResponseObject ?? ServiceOrder;
        SharedStateService.SetBanner(ServiceOrder.ShopBanner);
        CalculateTotals();
    }

    private bool ValidateParams()
    {
        return true; //Debug code

        if (!SharedStateService.ValidateSerialNumber(SerialNumber)) return false;
        if (!SharedStateService.ValidateServiceOrderRef(WorkItemRef, out Guid parsedWorkItemRef)) return false;

        ServiceOrder.Id = parsedWorkItemRef;

        return true;
    }

    private async Task ViewInspection()
    {
        var busyDialog = DialogService.Show<MudBusyDialog>("");

        var inspectionDoc = await httpClient.GetByteArrayAsync("samplepdf.pdf");

        SharedStateService.AddModel(SharedModelTypes.InspectionDocument, Convert.ToBase64String(inspectionDoc));
        // await SharedStateService.SaveToSession();

        busyDialog.Close();

        NavigationManager.NavigateTo($"/Document/{SharedModelTypes.InspectionDocument.ToString()}");
        // await InterOpService.OpenLinkInNewTab($"/Document/{SharedModelTypes.InspectionDocument.ToString()}");
    }

    private void CalculateTotals()
    {
        SubTotal = ServiceOrder.SubTotal + ServiceOrder.RequestsMarkedForApproval.Sum((x) => x.EstimatedLabour + x.EstimatedParts);
        Taxes = ServiceOrder.TaxTotal;
        Fees = ServiceOrder.FeesTotal;
    }

    private void SetApproval(RequestLine req, bool approved)
    {
        req.MarkedForApproval = approved;
        CalculateTotals();
    }

    private void Confirm()
    {
        if (ServiceOrder.PendingRequests.Any(x =>  !x.MarkedForApproval.HasValue))
        {
            SnackbarService.Add("Please Approve or Decline all Recommended Services Prior to Confirming", Severity.Error);
        }
    }
}
