@page "/CustomerAttachment"
@page "/CustomerAttachment/{SerialNumber}/{WorkItemRef}/{NotificationRef}"

<MudSessionErrorWrapper Validate="ValidateParams" FetchAsync="Initialize">
    <Content>
        <MudStack>
            <MudButton Style="align-self:center; width:fit-content"
                       Variant="Variant.Filled"
                       Color="Color.Tertiary"
                       OnClick="ViewRecommendations">
                @Resources.ViewYourRecommendations
            </MudButton>
            <MudSpacer />
            <MudAttachmentCarousel Attachments="Attachments" />
            <MudSpacer />
        </MudStack>
    </Content>
</MudSessionErrorWrapper>

@code {
    [Parameter]
    public string SerialNumber { get; set; } = string.Empty;
    [Parameter]
    public string WorkItemRef { get; set; } = string.Empty;
    [Parameter]
    public string NotificationRef { get; set; } = string.Empty;

    private List<Attachment> Attachments { get; set; } = new();

    private async Task Initialize()
    {
        var busyDialog = await DialogService.ShowAsync<MudBusyDialog>("");
        var img = await httpClient.GetByteArrayAsync("backgroundimg.jpg");

        var attachment1 = new Attachment();
        attachment1.Name = "Banner";
        attachment1.FileType = FileTypes.Image;
        attachment1.Content = Convert.FromBase64String(SharedStateService.GetBanner());

        var attachment2 = new Attachment();
        attachment2.Name = "Car";
        attachment2.FileType = FileTypes.Image;
        attachment2.Content = img;

        Attachments.Add(attachment2);
        Attachments.Add(attachment1);

        busyDialog.Close();
    }

    private bool ValidateParams()
    {
        return true; //debug code

        if (!SharedStateService.ValidateSerialNumber(SerialNumber)) return false;
        if (!SharedStateService.ValidateServiceOrderRef(WorkItemRef, out Guid parsedWorkItemRef)) return false;

        if (NotificationRef.IsNullOrWhitespace())
        {
            SharedStateService.AddError(Resources.UnableToLocateAttachments);
            return false;
        }

        return true;
    }

    private void ViewRecommendations()
    {
        NavigationManager.NavigateTo($"/WaitingForApproval/{SerialNumber}/{WorkItemRef}");
    }
}
